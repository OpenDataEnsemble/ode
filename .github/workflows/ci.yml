name: CI

on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
      - '.github/labeler.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  GO_VERSION: '1.24'

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      formulus: ${{ steps.filter.outputs.formulus }}
      formulus-formplayer: ${{ steps.filter.outputs.formulus-formplayer }}
      synkronus: ${{ steps.filter.outputs.synkronus }}
      synkronus-cli: ${{ steps.filter.outputs.synkronus-cli }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect changed components
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            formulus:
              - 'formulus/**'
            formulus-formplayer:
              - 'formulus-formplayer/**'
            synkronus:
              - 'synkronus/**'
            synkronus-cli:
              - 'synkronus-cli/**'

  yaml-lint:
    name: YAML Workflow Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install actionlint
        run: |
          curl -sSfL https://raw.githubusercontent.com/rhymond/actionlint/main/scripts/download-actionlint.bash | bash
          sudo mv actionlint /usr/local/bin/
      
      - name: Lint workflow files
        run: actionlint

  formulus:
    name: Formulus (React Native)
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.formulus == 'true' || github.event_name == 'workflow_dispatch' }}
    defaults:
      run:
        working-directory: ./formulus
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: formulus/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Check Prettier formatting
        run: npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}"
      
      - name: Run tests
        run: npm test -- --coverage --watchAll=false

  formulus-formplayer:
    name: Formulus Formplayer (React Web)
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.formulus-formplayer == 'true' || github.event_name == 'workflow_dispatch' }}
    defaults:
      run:
        working-directory: ./formulus-formplayer
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: formulus-formplayer/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Check Prettier formatting
        run: npx prettier --check "**/*.{js,jsx,ts,tsx,json,css,md}"
      
      - name: Run tests
        run: npm test -- --coverage --watchAll=false
      
      - name: Build
        run: npm run build

  synkronus:
    name: Synkronus (Go Backend)
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.synkronus == 'true' || github.event_name == 'workflow_dispatch' }}
    defaults:
      run:
        working-directory: ./synkronus
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: synkronus/go.sum
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Run gofmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -s -d .
            exit 1
          fi
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
          working-directory: ./synkronus
      
      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...
      
      - name: Build
        run: go build ./cmd/synkronus

  synkronus-cli:
    name: Synkronus CLI (Go CLI)
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.synkronus-cli == 'true' || github.event_name == 'workflow_dispatch' }}
    defaults:
      run:
        working-directory: ./synkronus-cli
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: synkronus-cli/go.sum
      
      - name: Verify dependencies
        run: go mod verify
      
      - name: Run gofmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted. Run 'go fmt ./...'"
            gofmt -s -d .
            exit 1
          fi
      
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
          working-directory: ./synkronus-cli
      
      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...
      
      - name: Build
        run: go build ./cmd/synkronus
